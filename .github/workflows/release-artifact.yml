name: Build and Release Artifact

on:
  push:
    tags:
      - 'v*' 

jobs:
  build-and-release:
    name: Build, Package and Release
    runs-on: ubuntu-latest
    permissions:
      contents: write 

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: Build Application
        run: pnpm build

      - name: Verify Build Output
        run: |
          if [ ! -d "dist" ]; then
            echo "âŒ dist folder not found!"
            ls -la
            exit 1
          fi

      - name: Create Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create ${{ github.ref_name }} \
            --title "Release ${{ github.ref_name }}" \
            --generate-notes \
            --verify-tag

      - name: Create Zip Artifact
        run: |
          # Extract version from tag (e.g., v1.0.0 -> 1.0.0)
          VERSION="${{ github.ref_name }}"
          VERSION="${VERSION#v}"
          ZIP_NAME="app-release-v${VERSION}.zip"
          
          echo "Zipping dist folder into $ZIP_NAME..."
          # Zip the contents of the build folder
          cd dist
          zip -r "../$ZIP_NAME" .
          cd ..
          
          # Output variable for next step
          echo "ARTIFACT_PATH=$ZIP_NAME" >> $GITHUB_ENV

      - name: Generate Checksum
        run: |
          sha256sum "${{ env.ARTIFACT_PATH }}" > "${{ env.ARTIFACT_PATH }}.sha256"


      - name: Upload Artifact for release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release upload ${{ github.ref_name }} \
            ${{ env.ARTIFACT_PATH }} \
            ${{ env.ARTIFACT_PATH }}.sha256 \
            --clobber