name: Build and Release Artifact

on:
  push:
    tags:
      - 'v*' 

jobs:
  build-and-release:
    name: Build and Zip
    runs-on: ubuntu-latest
    permissions:
      contents: write 

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 8

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: Build Application
        run: pnpm build

      - name: Create Zip Artifact
        run: |
          # Extract version from tag (e.g., v1.0.0 -> 1.0.0)
          VERSION=${GITHUB_REF#refs/tags/v}
          ZIP_NAME="app-release-v${VERSION}.zip"
          
          echo "Zipping dist folder into $ZIP_NAME..."
          # Zip the contents of the build folder
          zip -r "$ZIP_NAME" dist/
          
          # Output variable for next step
          echo "ARTIFACT_PATH=$ZIP_NAME" >> $GITHUB_ENV

      - name: Upload to GitHub Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release upload ${{ github.ref_name }} ${{ env.ARTIFACT_PATH }} --clobber